{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}KoreBase ERP{% endblock %}</title>

    <!-- Fuente Inter (Estándar Industrial Moderno) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Iconos FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Estilos KoreBase -->
    <link rel="stylesheet" href="{% static 'css/erp-style.css' %}">

    <!-- HTMX para la agilidad -->
    <script src="{% static 'js/htmx.min.js' %}"></script>
</head>

<body>

    {% if user.is_authenticated %}
    <div class="kore-layout">

        <!-- SIDEBAR: El Monolito -->
        <aside class="kore-sidebar" id="koreSidebar">
            <!-- Marca / Logo -->
            <div class="kore-brand">
                <!-- Logo Full -->
                <object data="{% static 'images/logo_no background.png' %}" type="image/png" class="kore-logo-full"
                    style="width: 240px; height: auto; max-height: 100px; filter: none; object-fit: contain;">
                    <i class="fas fa-cube kore-logo-icon"></i>
                </object>
                <!-- Logo Icon (Colapsado) -->
                <div class="kore-logo-collapsed"
                    style="display: none; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0 auto;">
                    <img src="{% static 'images/icon.png' %}" alt="K"
                        style="width: 100%; height: 100%; object-fit: contain; transform: scale(1.1);">
                </div>
            </div>

            <!-- Navegación -->
            <nav class="kore-nav">

                <div class="nav-label">General</div>

                <a href="{% url 'core:dashboard' %}"
                    class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                    title="Dashboard">
                    <div class="nav-icon"><i class="fas fa-th-large"></i></div>
                    <span class="nav-text">Dashboard</span>
                </a>

                <div class="nav-label">Módulos Operativos</div>

                <a href="{% url 'logistica:index' %}"
                    class="nav-item {% if 'logistica' in request.path %}active{% endif %}" title="Logística">
                    <div class="nav-icon"><i class="fas fa-warehouse"></i></div>
                    <span class="nav-text">Logística</span>
                </a>

                <a href="{% url 'produccion:index' %}"
                    class="nav-item {% if 'produccion' in request.path %}active{% endif %}" title="Producción">
                    <div class="nav-icon"><i class="fas fa-gears"></i></div>
                    <span class="nav-text">Producción</span>
                </a>

                <a href="{% url 'financiero:index' %}"
                    class="nav-item {% if 'financiero' in request.path %}active{% endif %}" title="Financiero">
                    <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
                    <span class="nav-text">Financiero</span>
                </a>

            </nav>

            <!-- Usuario Footer -->
            <div class="sidebar-footer">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;"
                    class="user-container">
                    <div class="user-avatar"
                        style="width: 36px; height: 36px; background: var(--kore-teal-500); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #0f172a; flex-shrink: 0;">
                        {{ user.username.0|upper }}
                    </div>
                    <div class="user-info-text">
                        <div style="font-size: 0.85rem; font-weight: 600;">{{ user.username }}</div>
                        <div style="font-size: 0.7rem; color: var(--kore-gray-500);">Gerente Operaciones</div>
                    </div>
                </div>
                <a href="{% url 'core:logout' %}" class="logout-link"
                    style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: #ef4444; opacity: 0.8; text-decoration: none;">
                    <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Cerrar Sesión</span>
                </a>
            </div>
        </aside>

        <!-- MAIN AREA -->
        <main class="kore-main" id="koreMain">
            <!-- Header Contextual -->
            <header class="kore-header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button id="sidebarToggle" class="icon-btn"
                        style="border: 1px solid var(--kore-gray-200); border-radius: 8px; width: 36px; height: 36px;">
                        <i class="fas fa-bars"></i>
                    </button>

                    {% block header_icon %}<div style="font-size: 1.5rem; color: var(--kore-teal-500);"><i
                            class="fas fa-cube"></i></div>{% endblock %}

                    <div class="header-title-container">
                        <h1 class="module-name">
                            {% block page_title %}Vista General{% endblock %}
                        </h1>
                    </div>
                </div>

                <div class="header-actions">
                    <!-- Buscador Global Dinámico -->
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Buscar orden, lote o producto...">
                    </div>

                    <!-- Botones de Acción con Animación -->
                    <button class="icon-btn notifications" title="Notificaciones">
                        <i class="fas fa-bell"></i>
                        <!-- Badge opcional -->
                        <span
                            style="position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; border: 2px solid white;"></span>
                    </button>
                    <button class="icon-btn settings" title="Configuración">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>

            <!-- Contenido Dinámico -->
            <div class="kore-content">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    {% else %}
    <!-- Login Layout Simple -->
    {% block login_content %}{% endblock %}
    {% endif %}

    {% block extra_js %}{% endblock %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleBtn = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('koreSidebar');
            const main = document.getElementById('koreMain');

            // Cargar estado guardado
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

            // Función auxiliar para aplicar estado
            function setCollapsedState(collapsed) {
                if (collapsed) {
                    sidebar.classList.add('collapsed');
                    main.classList.add('collapsed');
                } else {
                    sidebar.classList.remove('collapsed');
                    main.classList.remove('collapsed');
                }
            }

            // Aplicar estado inicial sin transición (opcional, aunque CSS transition está activa)
            if (isCollapsed) {
                setCollapsedState(true);
            }

            if (toggleBtn && sidebar && main) {
                toggleBtn.addEventListener('click', function () {
                    // Toggle class
                    sidebar.classList.toggle('collapsed');
                    main.classList.toggle('collapsed');

                    // Guardar nuevo estado
                    const currentState = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', currentState);
                });
            } else {
                console.error("Sidebar elements not found: ", { toggleBtn, sidebar, main });
            }
        });
    </script>
</body>

</html>